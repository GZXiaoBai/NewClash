name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-mac:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm install

      - name: Build macOS
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npm run build -- --mac

      - name: Upload macOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macOS-Build
          path: dist/*.dmg

  build-win:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm install

      - name: Build Windows
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npm run build -- --win

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Windows-Build
          path: dist/*.exe

  release:
    needs: [build-mac, build-win]
    runs-on: ubuntu-latest
    steps:
      - name: Download macOS Artifacts
        uses: actions/download-artifact@v4
        with:
          name: macOS-Build
          path: release/macos

      - name: Download Windows Artifacts
        uses: actions/download-artifact@v4
        with:
          name: Windows-Build
          path: release/windows

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/macos/*.dmg
            release/windows/*.exe
          body: |
            ## NewClash Premium Core æ›´æ–°æ—¥å¿— ğŸ‰
            
            **æœ¬æ¬¡æ›´æ–°åŒ…å«ä»¥ä¸‹ä¸»è¦å†…å®¹ï¼š**
            
            ### ğŸ¨ ç•Œé¢ä¸äº¤äº’ (UI/UX)
            - **æå…‰è§†è§‰å‡çº§**: å…¨æ–°çš„æ·±è‰²æ¯›ç»ç’ƒä¸»é¢˜ï¼Œæ­é…åŠ¨æ€æå…‰èƒŒæ™¯ä¸éœ“è™¹å…‰æ•ˆã€‚
            - **æ™ºèƒ½ä»ªè¡¨ç›˜**: é‡ç»˜äº†çŠ¶æ€å¡ç‰‡ä¸æµé‡æ³¢å½¢å›¾ï¼Œæ”¯æŒå®æ—¶è‰²å½©åé¦ˆã€‚
            - **ä¾§è¾¹æ ä¼˜åŒ–**: æ–°å¢æ¨¡å¼åˆ‡æ¢ç»„ä»¶ï¼Œæ”¯æŒè§„åˆ™ã€å…¨å±€ã€ç›´è¿ä¸‰ç§æ¨¡å¼çš„å¿«é€Ÿåˆ‡æ¢ã€‚
            
            ### ğŸš€ åŠŸèƒ½å¢å¼º (Features)
            - **ç³»ç»Ÿä»£ç†æ¥ç®¡**: å®Œç¾æ”¯æŒ macOS ç³»ç»Ÿä»£ç†è®¾ç½®ã€‚
            - **TUN æ¨¡å¼**: å†…ç½® TUN æ¨¡å¼å¼€å…³ï¼ˆéœ€ç®¡ç†å‘˜æƒé™ï¼‰ã€‚
            - **è¿æ¥ç®¡ç†**: æ”¯æŒå®æ—¶æŸ¥çœ‹ã€ç­›é€‰å¹¶æ–­å¼€æ´»åŠ¨è¿æ¥ã€‚
            
            ### ğŸ›  ä¿®å¤ä¸ä¼˜åŒ– (Fixes)
            - ä¿®å¤äº†ä»£ç†åˆ—è¡¨æ¸²æŸ“å¡é¡¿é—®é¢˜ã€‚
            - ä¼˜åŒ–äº†å†…æ ¸å¯åŠ¨ä¸ç«¯å£æ¸…ç†é€»è¾‘ã€‚
            
            ---
            *æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨æ„å»ºå‘å¸ƒã€‚*
            *ä¸‹è½½ Windows ç‰ˆæœ¬è¯·é€‰æ‹© .exeï¼ŒmacOS ç‰ˆæœ¬è¯·é€‰æ‹© .dmg*
          token: ${{ secrets.GITHUB_TOKEN }}
          draft: false
          prerelease: false

  check-android:
    runs-on: ubuntu-latest
    steps:
      - run: echo "::warning::Android build is skipped because this project uses Electron, which does not support mobile platforms (Android/iOS)."
